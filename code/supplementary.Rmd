---
title: "Supplementary material"

output:
  bookdown::word_document2:
    reference_docx: "../paper/template.docx"
editor_options: 
  markdown: 
    wrap: 72

knit: (function(input, ...) {
    rmarkdown::render(
      input,
      output_dir = "../paper"
    )
  })
---

```{r setup, include = FALSE, cache = FALSE}

# knitr setup
knitr::opts_chunk$set(echo = F, 
                      message = F,
                      warning = F,
                      dev = "jpeg",
                      dpi = 300,
                      fig.show = "hold",
                      fig.pos = "b", 
                      fig.path = "../figs/supplementary/figs/")

# str(knitr::opts_chunk$get()) # see for all options

```

```{r prep, include = FALSE, cache = FALSE}
#### LIBRARIES ####
require(pacman)

# load packages using pacman
pacman::p_load(tidyverse, lubridate, here, stats, zoo, scales, lvplot, ggpubr, gridExtra, patchwork, RColorBrewer)

# turn off scientific notation
options(scipen = 999, digits = 15)

# set directory
here::i_am("manuscript.rmd")

# set default theme for ggplot
theme_set(theme_minimal())

# define base ggplot theme
theme_update(plot.title = element_text(size = 14, colour = "grey20", face = "bold", hjust = 0.5),
             plot.subtitle = element_text(size = 10, colour = "grey20", face = "italic", hjust = 0.5, margin = margin(b = 10)),
             plot.caption = element_text(size = 10, colour = "grey20", face = "italic", hjust = 0.5),
             plot.background = element_rect(fill = "white", colour = NA),
             panel.grid.minor = element_blank(),
             panel.grid.major = element_blank(),
             axis.text = element_text(size = 10),
             strip.text = element_text(size = 10, color = "grey20", face = "bold"),
             strip.background = element_blank())

# colors
ls_colors <- c("Baseline" = "grey10",
               "Intervention" = "#fdbb84",
               "Measured interv" = "#fdbb84",
               "Conventional" = "grey70", 
               "Randomized" = "#99d8c9", 
               "Randomized\n(24 months)" = "#6baed6",
               "Randomized\n(50/50)" = "#6baed6",
               "Randomized\n(20/80)" = "#6baed6", 
               "Randomized\n(10/90)" = "#6baed6", 
               "Continued\n(20/80)" = "#c6dbef", 
               "Continued\n(10/90)" = "#c6dbef",
               "Daily\nsampling" = "#66c2a4",
               "2-day\nsampling" = "#66c2a4",
               "3-day\nsampling" = "#66c2a4",
               "7-day\nsampling" = "#66c2a4",
               "Dropped" = "#41ae76",
               "Kept" = "#006d2c",
               "Dropped (24 months)" = "#4292c6",
               "Kept (24 months)" = "#08519c",
               "Buildings finishing randomized M&V" =  "#99d8c9",
               "Buildings satisfying 80% TMY range" = "black", 
               "Buildings satisfying SPRT" = "black")

# parameters
ctr_params <- list(peak_hours = 10:16,
                   chwl_perc = 0.25,
                   step_perc = 0.08,
                   conv_swt = 6,
                   weather_knots = c(15, 25),
                   swt_knots = c(12, 7),
                   coe_peak = 0.8,
                   coe_off = 1.2,
                   enable_temp = 8)

occ_params <- list(change_start = 5,
                   change_end = 8,
                   change = 20)





#### FUNCTIONS ####
# Function defined to read downloaded tmy files
get_tmy <- function(all_sites, readfile_path){
  
  df_tmy <- data.frame()
  
  for (site in all_sites){
    df <- read_csv(paste0(readfile_path, "tmy/", str_glue("{site}.epw")),
                   skip = 8, col_types = "ddddd-d---------------------------------",
                   col_names = c("year", "month", "day", "hour", "min", "tmy")) %>%
      mutate(year = 2017,
             time = ymd_h(paste(paste(year, month, day, sep = "-"), hour, sep = " ")),
             temp = tmy) %>%
      dplyr::select(time, temp) %>% 
      mutate(site = site)
    
    df_tmy <- rbind(df_tmy, df)
  }
  
  return(df_tmy)
}

# Function defined to add chwst reset intervention
run_reset <- function(df_baseline){
  
  mean <- mean(df_baseline$base_eload, na.rm = T) * ctr_params$chwl_perc
  
  grad <- (ctr_params$swt_knots[2] - ctr_params$swt_knots[1]) / 
    (ctr_params$weather_knots[2] - ctr_params$weather_knots[1])
  
  interc <- ctr_params$swt_knots[2] - (ctr_params$weather_knots[2] * grad)
  
  df_interv <- df_baseline %>% 
    mutate(swt = t_out * grad + interc, 
           chwl = mean,
           hour = hour(datetime)) %>% 
    mutate(swt = ifelse(swt > ctr_params$swt_knots[1], ctr_params$swt_knots[1], ifelse(swt < ctr_params$swt_knots[2], ctr_params$swt_knots[2], swt)), 
           temp_savings = ifelse(t_out >= ctr_params$enable_temp, (swt - ctr_params$conv_swt) * ctr_params$step_perc, 0), 
           time_adj = ifelse(hour %in% ctr_params$peak_hours, ctr_params$coe_peak, ctr_params$coe_off), 
           perc_savings = temp_savings * time_adj, 
           savings = chwl * perc_savings, 
           interv_eload = base_eload - savings) %>% 
    select(datetime, base_eload, interv_eload, t_out)
  
  return(df_interv)
}

# Function defined to interpolate NAs
run_interpo <- function(df_all){
  
  na_counts <- df_all %>%
    mutate(date = date(timestamp)) %>%
    group_by(date) %>%
    summarize(na_hours = sum(is.na(eload)))
  
  # Filter out days with more than half of the hours having NAs
  valid_days <- na_counts %>%
    filter(na_hours <= 12) %>%
    pull(date)
  
  df_filtered <- df_all %>%
    filter(date(timestamp) %in% valid_days)
  
  df_filtered <- df_filtered %>%
    mutate(across(c(eload, t_out), ~ zoo::na.approx(., na.rm = FALSE))) %>% 
    rename(datetime = timestamp, 
           base_eload = eload)
  
  return(df_filtered)
}

# Function defined to adjust the plot scale
get_scale <- function(eload, range = 2){
  
  min_y <- mean(eload, na.rm = T) - range * sd(eload, na.rm = T)
  max_y <- mean(eload, na.rm = T) + range * sd(eload, na.rm = T)
  
  return(c(min_y, max_y))
}
```

```{r readdata, include=FALSE}

#### READ DATA ####
df_loc <- read.csv("../readfiles/loc_map.csv")

# stable dataset
readfile_stable <- str_glue("../readfiles/stable/")
fig_path = "../figs/manuscript/"

df_energy_stable <- read_rds(paste0(readfile_stable, "df_energy.rds"))
df_weather_stable <- read_rds(paste0(readfile_stable, "df_weather.rds"))
df_sprt_all_stable <- read_rds(paste0(readfile_stable, "df_sprt_all.rds"))
df_seq_fs_stable <- read_rds(paste0(readfile_stable, "df_seq_fs.rds"))
df_fs_stable <- read_rds(paste0(readfile_stable, "df_fs.rds"))
df_cont_stable <- read_rds(paste0(readfile_stable, "df_cont.rds"))
df_fs_null_stable <- read_rds(paste0(readfile_stable, "df_fs_null.rds"))
df_seq_fs_null_stable <- read_rds(paste0(readfile_stable, "df_seq_fs_null.rds"))
df_model_acc_stable <- read_rds(paste0(readfile_stable, "df_model_acc.rds"))
df_fs_tmy_stable <- read_rds(paste0(readfile_stable, "df_fs_tmy.rds"))
df_fs_tmy_null_stable <- read_rds(paste0(readfile_stable, "df_fs_tmy_null.rds"))
df_interval_drop_stable <- read_rds(paste0(readfile_stable, "df_interval_drop.rds"))
df_interval_keep_stable <- read_rds(paste0(readfile_stable, "df_interval_keep.rds"))
df_seq_interval_fs_drop_stable <- read_rds(paste0(readfile_stable, "df_seq_interval_fs_drop.rds"))
df_seq_interval_fs_keep_stable <- read_rds(paste0(readfile_stable, "df_seq_interval_fs_keep.rds"))
df_seq_interval_nm_drop_stable <- read_rds(paste0(readfile_stable, "df_seq_interval_nm_drop.rds"))
df_seq_interval_nm_keep_stable <- read_rds(paste0(readfile_stable, "df_seq_interval_nm_keep.rds"))
df_seq_interval_tl_drop_stable <- read_rds(paste0(readfile_stable, "df_seq_interval_tl_drop.rds"))
df_seq_interval_tl_keep_stable <- read_rds(paste0(readfile_stable, "df_seq_interval_tl_keep.rds"))


all_sites_stable <- df_energy_stable %>%
  select(site) %>%
  distinct() %>%
  arrange(site)

all_types_stable <- df_energy_stable %>%
  select(type) %>%
  mutate(type = as.factor(type)) %>%
  distinct()

all_names_stable <- df_energy_stable %>%
  select(name) %>%
  distinct(name)

# variable dataset
readfile_variable <- str_glue("../readfiles/variable/")

df_energy_variable <- read_rds(paste0(readfile_variable, "df_energy.rds"))
df_weather_variable <- read_rds(paste0(readfile_variable, "df_weather.rds"))
df_sprt_all_variable <- read_rds(paste0(readfile_variable, "df_sprt_all.rds"))
df_seq_fs_variable <- read_rds(paste0(readfile_variable, "df_seq_fs.rds"))
df_fs_variable <- read_rds(paste0(readfile_variable, "df_fs.rds"))
df_cont_variable <- read_rds(paste0(readfile_variable, "df_cont.rds"))
df_fs_null_variable <- read_rds(paste0(readfile_variable, "df_fs_null.rds"))
df_seq_fs_null_variable <- read_rds(paste0(readfile_variable, "df_seq_fs_null.rds"))
df_model_acc_variable <- read_rds(paste0(readfile_variable, "df_model_acc.rds"))
df_fs_tmy_variable <- read_rds(paste0(readfile_variable, "df_fs_tmy.rds"))
df_fs_tmy_null_variable <- read_rds(paste0(readfile_variable, "df_fs_tmy_null.rds"))
df_interval_drop_variable <- read_rds(paste0(readfile_variable, "df_interval_drop.rds"))
df_interval_keep_variable <- read_rds(paste0(readfile_variable, "df_interval_keep.rds"))
df_seq_interval_fs_drop_variable <- read_rds(paste0(readfile_variable, "df_seq_interval_fs_drop.rds"))
df_seq_interval_fs_keep_variable <- read_rds(paste0(readfile_variable, "df_seq_interval_fs_keep.rds"))
df_seq_interval_nm_drop_variable <- read_rds(paste0(readfile_variable, "df_seq_interval_nm_drop.rds"))
df_seq_interval_nm_keep_variable <- read_rds(paste0(readfile_variable, "df_seq_interval_nm_keep.rds"))
df_seq_interval_tl_drop_variable <- read_rds(paste0(readfile_variable, "df_seq_interval_tl_drop.rds"))
df_seq_interval_tl_keep_variable <- read_rds(paste0(readfile_variable, "df_seq_interval_tl_keep.rds"))

all_sites_variable <- df_energy_variable %>%
  select(site) %>%
  distinct() %>%
  arrange(site)

all_types_variable <- df_energy_variable %>%
  select(type) %>%
  mutate(type = as.factor(type)) %>%
  distinct()

all_names_variable <- df_energy_variable %>%
  select(name) %>%
  distinct(name)

# read functions
function_path <- "../functions/"
source(paste0(function_path, "model_fit.R"))
source(paste0(function_path, "model_pred.R"))
source(paste0(function_path, "prepost_plot.R"))

S_building <- nrow(df_fs_tmy_stable)
V_building <- nrow(df_fs_tmy_variable)
A_building <- S_building + V_building
```

```{r absnull, fig.cap="Comparison between the two M&V methods in detecting no intervention effect (expressed without absolute calculation) when buildings are subject to baseline change.", fig.height=6, fig.width=12}
#### ABS-NULL ####
rand_eob_S <- df_seq_fs_null_stable %>% 
  filter(seq == "eob") %>% 
  mutate(diff = abs(0 - fs), 
         method = "rand_eob") %>% 
  select(name, method, diff)

conv_S <- df_fs_null_stable %>% 
  filter(method != "rand") %>% 
  pivot_wider(names_from = method, values_from = savings) %>% 
  mutate(diff = abs(true - conv), 
         method = "conv") %>% 
  select(name, method, diff)

rand_final_S <- df_fs_null_stable %>% 
  filter(method != "conv") %>% 
  pivot_wider(names_from = method, values_from = savings) %>% 
  mutate(diff = abs(true - rand), 
         method = "rand_final") %>% 
  select(name, method, diff)

df_MW_S <- rbind(rand_eob_S, conv_S, rand_final_S)

# plot for the variable subset
rand_eob_V <- df_seq_fs_null_variable %>% 
  filter(seq == "eob") %>% 
  mutate(diff = abs(0 - fs), 
         method = "rand_eob") %>% 
  select(name, method, diff)

conv_V <- df_fs_null_variable %>% 
  filter(method != "rand") %>% 
  pivot_wider(names_from = method, values_from = savings) %>% 
  mutate(diff = abs(true - conv), 
         method = "conv") %>% 
  select(name, method, diff)

rand_final_V <- df_fs_null_variable %>% 
  filter(method != "conv") %>% 
  pivot_wider(names_from = method, values_from = savings) %>% 
  mutate(diff = abs(true - rand), 
         method = "rand_final") %>% 
  select(name, method, diff)

df_MW_V <- rbind(rand_eob_V, conv_V, rand_final_V)

# plot for combined dataset
rand_eob_A <- bind_rows(rand_eob_V, rand_eob_S) %>% 
  select(name, rand_eob_diff = diff)

conv_A <- bind_rows(conv_V, conv_S) %>% 
  select(name, conv_diff = diff)

rand_final_A <- bind_rows(rand_final_V, rand_final_S) %>% 
  select(name, rand_final_diff = diff)

df_MW_A <- rand_eob_A %>% 
  left_join(conv_A, by = "name") %>% 
  left_join(rand_final_A, by = "name") %>% 
  pivot_longer(c(rand_eob_diff, conv_diff, rand_final_diff), names_to = "method", values_to = "diff")

df_MW_A %>% 
  mutate(method = as.factor(method), 
         method = recode_factor(method, "conv_diff" = "Conventional", "rand_eob_diff" = "Randomized", "rand_final_diff" = "Randomized\n(24 months)")) %>% 
  ggplot(aes(x = method, y = diff, fill = method)) +
  geom_jitter(width = 0.2, alpha = 0.8, size = 0.5) +
  geom_lv(k = 4, outlier.shape = NA) +
  geom_boxplot(outlier.alpha = 0, coef = 0, fill = "#00000000", aes(color = method)) +
  geom_text(data = . %>% group_by(method) %>% summarise(median = median(diff)) %>% ungroup(), 
            aes(x = method, y = median, label = paste0(round(median, digits = 1), " %")), 
            size = 4) +
  scale_y_continuous(expand = c(0, 0), 
                     breaks = breaks_pretty(n = 4), 
                     labels = number_format(suffix = " %")) +
  scale_fill_manual(values = ls_colors) +
  scale_color_manual(values = c("grey80", "grey80", "grey80")) + 
  labs(fill = NULL, 
       x = NULL, 
       y = "Absolute effect in fractional savings", 
       title = "Absolute effect of non-routine events when using different M&V methods", 
       subtitle = str_glue("All {A_building} buildings wither measured weather")) +
  coord_cartesian(ylim = c(0, 23)) +
  theme(panel.grid.major.y = element_line(color = "grey80", linewidth = 0.25),
        legend.position = "none",
        plot.margin = margin(t = 2, r = 7, b = 2, l = 2, unit = "mm"))
```

```{r meancont, fig.cap="Comparison of different sampling ratio impact on M&V estimation accuracy (expressed without absolute calculation for errors)", fig.height=8, fig.width=12}

#### MEAN-CONT ####
df_MW_S <- df_cont_stable %>% 
  left_join(df_fs_stable %>% filter(scenario == "ref" & method == "true"), by = c("name", "site")) %>% 
  mutate(diff = savings - cont_fs, 
         diff_all = savings - cont_fs_all) %>% 
  select(name, diff, diff_all, ratio) %>% 
  pivot_longer(c(diff, diff_all), names_to = "type", values_to = "values") %>% 
  mutate(ratio = ifelse(ratio == 1 & type == "diff", "1_1", 
                        ifelse(ratio == 1 & type == "diff_all", "1_2", 
                               ifelse(ratio == 2 & type == "diff", "2_1", 
                                      ifelse(ratio == 2 & type == "diff_all", "2_2", ratio))))) %>% 
  bind_rows(df_fs_stable %>% 
              filter(method != "conv") %>% 
              pivot_wider(names_from = method, values_from = savings) %>% 
              mutate(values = true - rand, 
                     ratio = "0", 
                     type = "diff_ref") %>% 
              select(name, values, ratio, type))


# plot for the variable subset
df_MW_V <- df_cont_variable %>% 
  left_join(df_fs_variable %>% filter(scenario == "ref" & method == "true"), by = c("name", "site")) %>% 
  mutate(diff = savings - cont_fs, 
         diff_all = savings - cont_fs_all) %>% 
  select(name, diff, diff_all, ratio) %>% 
  pivot_longer(c(diff, diff_all), names_to = "type", values_to = "values") %>% 
  mutate(ratio = ifelse(ratio == 1 & type == "diff", "1_1", 
                        ifelse(ratio == 1 & type == "diff_all", "1_2", 
                               ifelse(ratio == 2 & type == "diff", "2_1", 
                                      ifelse(ratio == 2 & type == "diff_all", "2_2", ratio))))) %>% 
  bind_rows(df_fs_variable %>% 
              filter(method != "conv") %>% 
              pivot_wider(names_from = method, values_from = savings) %>% 
              mutate(values = true - rand, 
                     ratio = "0", 
                     type = "diff_ref") %>% 
              select(name, values, ratio, type))

# plot for combined dataset
df_MW_A <- rbind(df_MW_S, df_MW_V)

p_top <- df_MW_A %>% 
  mutate(ratio = as.factor(ratio), 
         ratio = recode_factor(ratio, 
                               "0" = "Randomized\n(50/50)", 
                               "1_1" = "Continued\n(20/80)", 
                               "1_2" = "Randomized\n(20/80)", 
                               "2_1" = "Continued\n(10/90)", 
                               "2_2" = "Randomized\n(10/90)")) %>% 
  ggplot(aes(x = ratio, y = values, fill = ratio)) +
  geom_jitter(width = 0.2, alpha = 0.8, size = 0.5) +
  geom_lv(k = 4, outlier.shape = NA, position = position_jitterdodge(dodge.width = 0.75, jitter.width = 0.1)) +
  geom_boxplot(outlier.alpha = 0, coef = 0, fill = "#00000000", aes(color = ratio), width = 0.75, linewidth = 0.15) +
  geom_vline(xintercept = 1.5, color = "#fb8072", linewidth = 1, lty = "dashed") +
  geom_text(data = . %>% 
              group_by(ratio) %>% 
              summarise(median = median(values)) %>% 
              ungroup(), 
            aes(x = ratio, y = median, label = paste0(round(median, digits = 1), " %")), 
            size = 4) +
  scale_y_continuous(expand = c(0, 0), 
                     breaks = breaks_pretty(n = 5), 
                     labels = number_format(suffix = " %")) +
  scale_fill_manual(values = ls_colors) +
  scale_color_manual(values = c("grey80", "grey80", "grey80", "grey80", "grey80")) + 
  labs(fill = NULL, 
       x = NULL, 
       y = "Absolute error in fractional savings", 
       subtitle = str_glue("All {A_building} buildings with measured weather conditions")) +
  coord_cartesian(ylim = c(-12, 15)) +
  theme(panel.grid.major.y = element_line(color = "grey80", linewidth = 0.25),
        legend.position = "none",
        axis.text.x = element_blank(), 
        plot.margin = margin(t = 2, r = 7, b = 2, l = 2, unit = "mm"))

# TMY
# plot for the stable subset
df_TW_S <- df_cont_stable %>% 
  left_join(df_fs_stable %>% filter(scenario == "ref" & method == "true"), by = c("name", "site")) %>% 
  mutate(diff = savings - cont_tmy, 
         diff_all = savings - cont_tmy_all) %>% 
  select(name, diff, diff_all, ratio) %>% 
  pivot_longer(c(diff, diff_all), names_to = "type", values_to = "values") %>% 
  mutate(ratio = ifelse(ratio == 1 & type == "diff", "1_1", 
                        ifelse(ratio == 1 & type == "diff_all", "1_2", 
                               ifelse(ratio == 2 & type == "diff", "2_1", 
                                      ifelse(ratio == 2 & type == "diff_all", "2_2", ratio))))) %>% 
  bind_rows(df_fs_tmy_stable %>% 
              left_join(df_fs_stable %>% filter(scenario == "ref" & method == "true"), by = c("name", "site")) %>% 
              mutate(values = savings - rand, 
                     ratio = "0", 
                     type = "diff_ref") %>% 
              select(name, values, ratio, type))

# plot for the variable subset
df_TW_V <- df_cont_variable %>% 
  left_join(df_fs_variable %>% filter(scenario == "ref" & method == "true"), by = c("name", "site")) %>% 
  mutate(diff = savings - cont_tmy, 
         diff_all = savings - cont_tmy_all) %>% 
  select(name, diff, diff_all, ratio) %>% 
  pivot_longer(c(diff, diff_all), names_to = "type", values_to = "values") %>% 
  mutate(ratio = ifelse(ratio == 1 & type == "diff", "1_1", 
                        ifelse(ratio == 1 & type == "diff_all", "1_2", 
                               ifelse(ratio == 2 & type == "diff", "2_1", 
                                      ifelse(ratio == 2 & type == "diff_all", "2_2", ratio))))) %>% 
  bind_rows(df_fs_tmy_variable %>% 
              left_join(df_fs_variable %>% filter(scenario == "ref" & method == "true"), by = c("name", "site")) %>% 
              mutate(values = savings - rand, 
                     ratio = "0", 
                     type = "diff_ref") %>% 
              select(name, values, ratio, type))

# plot for combined dataset
df_TW_A <- rbind(df_TW_S, df_TW_V)

p_bottom <- df_TW_A %>% 
  mutate(ratio = as.factor(ratio), 
         ratio = recode_factor(ratio, 
                               "0" = "Randomized\n(50/50)", 
                               "1_1" = "Continued\n(20/80)", 
                               "1_2" = "Randomized\n(20/80)", 
                               "2_1" = "Continued\n(10/90)", 
                               "2_2" = "Randomized\n(10/90)")) %>% 
  ggplot(aes(x = ratio, y = values, fill = ratio)) +
  geom_jitter(width = 0.2, alpha = 0.8, size = 0.5) +
  geom_lv(k = 4, outlier.shape = NA, position = position_jitterdodge(dodge.width = 0.75, jitter.width = 0.1)) +
  geom_boxplot(outlier.alpha = 0, coef = 0, fill = "#00000000", aes(color = ratio), width = 0.75, linewidth = 0.15) +
  geom_vline(xintercept = 1.5, color = "#fb8072", linewidth = 1, lty = "dashed") +
  geom_text(data = . %>% 
              group_by(ratio) %>% 
              summarise(median = median(values)) %>% 
              ungroup(), 
            aes(x = ratio, y = median, label = paste0(round(median, digits = 1), " %")), 
            size = 4) +
  scale_y_continuous(expand = c(0, 0), 
                     breaks = breaks_pretty(n = 5), 
                     labels = number_format(suffix = " %")) +
  scale_fill_manual(values = ls_colors) +
  scale_color_manual(values = c("grey80", "grey80", "grey80", "grey80", "grey80")) + 
  labs(fill = NULL, 
       x = NULL, 
       y = "Absolute error in fractional savings", 
       subtitle = str_glue("All {A_building} buildings with TOWT model and TMY weather")) +
  coord_cartesian(ylim = c(-12, 15)) +
  theme(panel.grid.major.y = element_line(color = "grey80", linewidth = 0.25),
        legend.position = "none",
        plot.margin = margin(t = 2, r = 7, b = 2, l = 2, unit = "mm"))

ggarrange(p_top, p_bottom, 
          ncol = 1, nrow = 2,
          labels = c("a)", "b)")) +
  plot_annotation(title = "Absolute error in savings estimation by different sampling ratio")
```

```{r absint2y, fig.cap="Comparison of different sampling interval impact on M&V estimation accuracy over the course of two years (dropped: all non-consecutive days were dropped; kept: all measurements were kept)", fig.height=9, fig.width=12}
# dropped version
df_interval_keep_stable %<>% 
  left_join(df_fs_stable %>% filter(method == "rand"), by = c("name", "site")) %>% 
  select(-c("scenario", "method")) %>% 
  rename("interval_fs_1" = "savings") %>% 
  left_join(df_fs_tmy_stable, by = c("name", "site")) %>% 
  select(-conv) %>% 
  rename("interval_tmy_1" = "rand")

df_interval_keep_variable %<>% 
  left_join(df_fs_variable %>% filter(method == "rand"), by = c("name", "site")) %>% 
  select(-c("scenario", "method")) %>% 
  rename("interval_fs_1" = "savings") %>% 
  left_join(df_fs_tmy_variable, by = c("name", "site")) %>% 
  select(-conv) %>% 
  rename("interval_tmy_1" = "rand")

df_drop <- df_interval_drop_stable %>% 
  bind_rows(df_interval_drop_variable) %>% 
  select(name, contains("fs")) %>% 
  rename("drop_1" = "interval_fs_1", 
         "drop_2" = "interval_fs_2", 
         "drop_3" = "interval_fs_3", 
         "drop_7" = "interval_fs_7")  

df_keep <- df_interval_keep_stable %>% 
  bind_rows(df_interval_keep_variable) %>% 
  select(name, contains("fs")) %>% 
  rename("keep_1" = "interval_fs_1",
         "keep_2" = "interval_fs_2", 
         "keep_3" = "interval_fs_3", 
         "keep_7" = "interval_fs_7")

df_MW_A <- df_drop %>% 
  left_join(df_keep, by = c("name")) %>%
  left_join(rbind(df_fs_stable %>% 
                    filter(scenario == "ref" & method == "true"), 
                  df_fs_variable %>% 
                    filter(scenario == "ref" & method == "true")), by = "name") %>% 
  mutate(drop_1 = abs(savings - drop_1),
         drop_2 = abs(savings - drop_2), 
         drop_3 = abs(savings - drop_3), 
         drop_7 = abs(savings - drop_7), 
         keep_1 = abs(savings - keep_1),
         keep_2 = abs(savings - keep_2), 
         keep_3 = abs(savings - keep_3), 
         keep_7 = abs(savings - keep_7)) %>% 
  pivot_longer(cols = contains("drop") | contains("keep"),  
               names_to = c("group", "interval"),
               names_pattern = "(drop|keep)_(\\d+)",
               values_to = "diff")

p_top <- df_MW_A %>% 
  mutate(interval = as.factor(interval), 
         interval = recode_factor(interval, 
                                  "1" = "1-day\nsampling",
                                  "2" = "2-day\nsampling", 
                                  "3" = "3-day\nsampling", 
                                  "7" = "7-day\nsampling"), 
         group = as.factor(group), 
         group = recode_factor(group, "drop" = "Dropped", "keep" = "Kept")) %>% 
  ggplot(aes(x = interval, y = diff, fill = group)) +
  geom_jitter(alpha = 0.8, 
              size = 0.5, 
              position = position_jitterdodge(dodge.width = 0.75, jitter.width = 0.2)) +
  geom_lv(k = 4, outlier.shape = NA, position = position_dodge(width = 0.8)) +
  geom_boxplot(outlier.alpha = 0, coef = 0, fill = "#00000000", aes(color = group), width = 0.8, linewidth = 0.15) +
  geom_text(data = . %>% group_by(group, interval) %>% summarise(median = median(diff, na.rm = T)) %>% ungroup(), 
            aes(x = interval, y = median, group = group,
                label = paste0(round(median, digits = 1), " %")), 
            position = position_dodge(width = 0.75), 
            size = 4, 
            color = "white") +
  scale_y_continuous(expand = c(0, 0), 
                     breaks = breaks_pretty(n = 4), 
                     labels = number_format(suffix = " %")) +
  scale_fill_manual(values = ls_colors) +
  scale_color_manual(values = c("grey80", "grey80")) + 
  labs(fill = NULL, 
       color = NULL, 
       x = NULL, 
       y = "Absolute error in fractional savings", 
       subtitle = str_glue("All {A_building} buildings with measured weather")) +
  coord_cartesian(ylim = c(0, 8)) +
  theme(panel.grid.major.y = element_line(color = "grey80", linewidth = 0.25),
        legend.position = "bottom",
        axis.text.x = element_blank(),
        plot.margin = margin(t = 2, r = 7, b = 2, l = 2, unit = "mm"))

# TMY version
df_drop <- df_interval_drop_stable %>% 
  bind_rows(df_interval_drop_variable) %>% 
  select(name, contains("tmy")) %>% 
  rename("drop_1" = "interval_tmy_1",
         "drop_2" = "interval_tmy_2", 
         "drop_3" = "interval_tmy_3", 
         "drop_7" = "interval_tmy_7")  

df_keep <- df_interval_keep_stable %>% 
  bind_rows(df_interval_keep_variable) %>% 
  select(name, contains("tmy")) %>% 
  rename("keep_1" = "interval_tmy_1",
         "keep_2" = "interval_tmy_2", 
         "keep_3" = "interval_tmy_3", 
         "keep_7" = "interval_tmy_7")

df_TW_A <- df_drop %>% 
  left_join(df_keep, by = c("name")) %>%
  left_join(rbind(df_fs_stable %>% 
                    filter(scenario == "ref" & method == "true"), 
                  df_fs_variable %>% 
                    filter(scenario == "ref" & method == "true")), by = "name") %>% 
  mutate(drop_1 = abs(savings - drop_1),
         drop_2 = abs(savings - drop_2), 
         drop_3 = abs(savings - drop_3), 
         drop_7 = abs(savings - drop_7), 
         keep_1 = abs(savings - keep_1),
         keep_2 = abs(savings - keep_2), 
         keep_3 = abs(savings - keep_3), 
         keep_7 = abs(savings - keep_7)) %>% 
  pivot_longer(cols = contains("drop") | contains("keep"),  
               names_to = c("group", "interval"),
               names_pattern = "(drop|keep)_(\\d+)",
               values_to = "diff")

p_bottom <- df_TW_A %>% 
  mutate(interval = as.factor(interval), 
         interval = recode_factor(interval, 
                                  "1" = "1-day\nsampling",
                                  "2" = "2-day\nsampling", 
                                  "3" = "3-day\nsampling", 
                                  "7" = "7-day\nsampling"), 
         group = as.factor(group), 
         group = recode_factor(group, "drop" = "Dropped", "keep" = "Kept")) %>% 
  ggplot(aes(x = interval, y = diff, fill = group)) +
  geom_jitter(alpha = 0.8, 
              size = 0.5, 
              position = position_jitterdodge(dodge.width = 0.75, jitter.width = 0.2)) +
  geom_lv(k = 4, outlier.shape = NA, position = position_dodge(width = 0.8)) +
  geom_boxplot(outlier.alpha = 0, coef = 0, fill = "#00000000", aes(color = group), width = 0.8, linewidth = 0.15) +
  geom_text(data = . %>% group_by(group, interval) %>% summarise(median = median(diff, na.rm = T)) %>% ungroup(), 
            aes(x = interval, y = median, group = group,
                label = paste0(round(median, digits = 1), " %")), 
            position = position_dodge(width = 0.75), 
            size = 4,
            color = "white") +
  scale_y_continuous(expand = c(0, 0), 
                     breaks = breaks_pretty(n = 4), 
                     labels = number_format(suffix = " %")) +
  scale_fill_manual(values = ls_colors) +
  scale_color_manual(values = c("grey80", "grey80")) + 
  labs(fill = NULL, 
       color = NULL, 
       x = NULL, 
       y = "Absolute error in fractional savings", 
       subtitle = str_glue("All {A_building} buildings with TOWT model and TMY weather")) +
  coord_cartesian(ylim = c(0, 8)) +
  theme(panel.grid.major.y = element_line(color = "grey80", linewidth = 0.25),
        legend.position = "bottom",
        plot.margin = margin(t = 2, r = 7, b = 2, l = 2, unit = "mm"))

ggarrange(p_top, p_bottom, 
          ncol = 1, nrow = 2, 
          align = "hv", 
          labels = c("a)", "b)"),
          common.legend = T, 
          legend = "bottom") +
  plot_annotation(title = "Absolute error in savings estimation of ranodmized M&V by different sampling intervals")
```

```{r meanintspt, fig.cap="Comparison of different sampling interval impact on M&V estimation accuracy after satisfying all stopping criteria (without absolute calculation)", fig.height=9, fig.width=12}
# sprt sequence plot for different sampling intervals
df_seq_interval_fs_keep_stable %<>% 
  select(-c(sprt, temp, final)) %>% 
  bind_rows(df_seq_fs_stable %>% 
              filter(seq == "eob") %>% 
              select(-seq) %>% 
              mutate(interval = 1) %>% 
              rename(eob = "fs"))  

df_seq_interval_fs_keep_variable %<>% 
  select(-c(sprt, temp, final)) %>% 
  bind_rows(df_seq_fs_variable %>% 
              filter(seq == "eob") %>% 
              select(-seq) %>% 
              mutate(interval = 1) %>% 
              rename(eob = "fs")) 

df_drop <- df_seq_interval_fs_drop_stable %>% 
  bind_rows(df_seq_interval_fs_drop_variable) %>% 
  select(name, eob, interval) %>% 
  mutate(group = "drop")

df_keep <- df_seq_interval_fs_keep_stable %>% 
  bind_rows(df_seq_interval_fs_keep_variable) %>% 
  select(name, eob, interval) %>% 
  mutate(group = "keep")

df_MW_A <- df_drop %>% 
  bind_rows(df_keep) %>% 
  left_join(rbind(df_fs_stable %>% 
                    filter(scenario == "ref" & method == "true"), 
                  df_fs_variable %>% 
                    filter(scenario == "ref" & method == "true")), by = "name") %>% 
  mutate(diff = (savings - eob)) %>% 
  filter(is.finite(diff))

p_top <- df_MW_A %>% 
  mutate(interval = as.factor(interval), 
         interval = recode_factor(interval, 
                                  "1" = "1-day\nsampling",
                                  "2" = "2-day\nsampling", 
                                  "3" = "3-day\nsampling", 
                                  "7" = "7-day\nsampling"), 
         group = as.factor(group), 
         group = recode_factor(group, "drop" = "Dropped", "keep" = "Kept")) %>% 
  ggplot(aes(x = interval, y = diff, fill = group)) +
  geom_jitter(alpha = 0.8, 
              size = 0.5, 
              position = position_jitterdodge(dodge.width = 0.75, jitter.width = 0.2)) +
  geom_lv(k = 4, outlier.shape = NA, position = position_dodge(width = 0.8)) +
  geom_boxplot(outlier.alpha = 0, coef = 0, fill = "#00000000", aes(color = group), width = 0.8, linewidth = 0.15) +
  geom_hline(yintercept = 0, color = "#fb8072", linewidth = 1, lty = "dashed") +
  geom_text(data = . %>% group_by(group, interval) %>% summarise(median = median(diff, inf.rm = T)) %>% ungroup(), 
            aes(x = interval, y = median, group = group,
                label = paste0(round(median, digits = 1), " %")), 
            position = position_dodge(width = 0.75), 
            size = 4, 
            color = "white") +
  scale_y_continuous(expand = c(0, 0), 
                     breaks = breaks_pretty(n = 5), 
                     labels = number_format(suffix = " %")) +
  scale_fill_manual(values = ls_colors) +
  scale_color_manual(values = c("grey80", "grey80")) + 
  labs(fill = NULL, 
       color = NULL, 
       x = NULL, 
       y = "Estimated error in fractional savings", 
       subtitle = str_glue("All {A_building} buildings with measured weather")) +
  coord_cartesian(ylim = c(-12, 12)) +
  theme(panel.grid.major.y = element_line(color = "grey80", linewidth = 0.25),
        legend.position = "bottom",
        axis.text.x = element_blank(),
        plot.margin = margin(t = 2, r = 7, b = 2, l = 2, unit = "mm"))

# with tmy version
df_seq_interval_nm_keep_stable %<>% 
  select(-c(sprt, temp, final)) %>% 
  bind_rows(df_sprt_all_stable %>% 
              filter(seq == "eob") %>% 
              select(-c(seq, n_weeks)) %>% 
              mutate(interval = 1) %>% 
              rename(eob = "annual")) 

df_seq_interval_nm_keep_variable %<>% 
  select(-c(sprt, temp, final)) %>% 
  bind_rows(df_sprt_all_variable %>% 
              filter(seq == "eob") %>% 
              select(-c(seq, n_weeks)) %>% 
              mutate(interval = 1) %>% 
              rename(eob = "annual")) 

df_drop <- df_seq_interval_nm_drop_stable %>% 
  bind_rows(df_seq_interval_nm_drop_variable) %>% 
  select(name, eob, interval) %>% 
  mutate(group = "drop")

df_keep <- df_seq_interval_nm_keep_stable %>% 
  bind_rows(df_seq_interval_nm_keep_variable) %>% 
  select(name, eob, interval) %>% 
  mutate(group = "keep")

df_TW_A <- df_drop %>% 
  bind_rows(df_keep) %>% 
  left_join(rbind(df_fs_stable %>% 
                    filter(scenario == "ref" & method == "true"), 
                  df_fs_variable %>% 
                    filter(scenario == "ref" & method == "true")), by = "name") %>% 
  mutate(diff = (savings - eob)) %>% 
  filter(is.finite(diff))

p_bottom <- df_TW_A %>% 
  mutate(interval = as.factor(interval), 
         interval = recode_factor(interval, 
                                  "1" = "1-day\nsampling",
                                  "2" = "2-day\nsampling", 
                                  "3" = "3-day\nsampling", 
                                  "7" = "7-day\nsampling"), 
         group = as.factor(group), 
         group = recode_factor(group, "drop" = "Dropped", "keep" = "Kept")) %>% 
  ggplot(aes(x = interval, y = diff, fill = group)) +
  geom_jitter(alpha = 0.8, 
              size = 0.5, 
              position = position_jitterdodge(dodge.width = 0.75, jitter.width = 0.2)) +
  geom_lv(k = 4, outlier.shape = NA, position = position_dodge(width = 0.8)) +
  geom_boxplot(outlier.alpha = 0, coef = 0, fill = "#00000000", aes(color = group), width = 0.8, linewidth = 0.15) +
  geom_hline(yintercept = 0, color = "#fb8072", linewidth = 1, lty = "dashed") +
  geom_text(data = . %>% group_by(group, interval) %>% summarise(median = median(diff, na.rm = T)) %>% ungroup(), 
            aes(x = interval, y = median, group = group,
                label = paste0(round(median, digits = 1), " %")), 
            position = position_dodge(width = 0.75), 
            size = 4, 
            color = "white") +
  scale_y_continuous(expand = c(0, 0), 
                     breaks = breaks_pretty(n = 5), 
                     labels = number_format(suffix = " %")) +
  scale_fill_manual(values = ls_colors) +
  scale_color_manual(values = c("grey80", "grey80")) + 
  labs(fill = NULL, 
       color = NULL, 
       x = NULL, 
       y = "Esimated error in fractional savings", 
       subtitle = str_glue("All {A_building} buildings with TOWT model and TMY weather")) +
  coord_cartesian(ylim = c(-12, 12)) +
  theme(panel.grid.major.y = element_line(color = "grey80", linewidth = 0.25),
        legend.position = "bottom",
        plot.margin = margin(t = 2, r = 7, b = 2, l = 2, unit = "mm"))

ggarrange(p_top, p_bottom, 
          ncol = 1, nrow = 2, 
          align = "hv", 
          labels = c("a)", "b)"),
          common.legend = T, 
          legend = "bottom") +
  plot_annotation(title = "Estimated error in savings estimation of randomized M&V after satisfying all stopping criteria")

```

```{r meanint2y, fig.cap="Comparison of different sampling interval impact on M&V estimation accuracy over the course of the two years (without absolute calculation)", fig.width=12, fig.height=9}
# dropped version
df_drop <- df_interval_drop_stable %>% 
  bind_rows(df_interval_drop_variable) %>% 
  select(name, contains("fs")) %>% 
  rename("drop_1" = "interval_fs_1", 
         "drop_2" = "interval_fs_2", 
         "drop_3" = "interval_fs_3", 
         "drop_7" = "interval_fs_7")  

df_keep <- df_interval_keep_stable %>% 
  bind_rows(df_interval_keep_variable) %>% 
  select(name, contains("fs")) %>% 
  rename("keep_1" = "interval_fs_1",
         "keep_2" = "interval_fs_2", 
         "keep_3" = "interval_fs_3", 
         "keep_7" = "interval_fs_7")

df_MW_A <- df_drop %>% 
  left_join(df_keep, by = c("name")) %>%
  left_join(rbind(df_fs_stable %>% 
                    filter(scenario == "ref" & method == "true"), 
                  df_fs_variable %>% 
                    filter(scenario == "ref" & method == "true")), by = "name") %>% 
  mutate(drop_1 = savings - drop_1,
         drop_2 = savings - drop_2, 
         drop_3 = savings - drop_3, 
         drop_7 = savings - drop_7, 
         keep_1 = savings - keep_1,
         keep_2 = savings - keep_2, 
         keep_3 = savings - keep_3, 
         keep_7 = savings - keep_7) %>% 
  pivot_longer(cols = contains("drop") | contains("keep"),  
               names_to = c("group", "interval"),
               names_pattern = "(drop|keep)_(\\d+)",
               values_to = "diff")

p_top <- df_MW_A %>% 
  mutate(interval = as.factor(interval), 
         interval = recode_factor(interval, 
                                  "1" = "1-day\nsampling",
                                  "2" = "2-day\nsampling", 
                                  "3" = "3-day\nsampling", 
                                  "7" = "7-day\nsampling"), 
         group = as.factor(group), 
         group = recode_factor(group, "drop" = "Dropped", "keep" = "Kept")) %>% 
  ggplot(aes(x = interval, y = diff, fill = group)) +
  geom_jitter(alpha = 0.8, 
              size = 0.5, 
              position = position_jitterdodge(dodge.width = 0.75, jitter.width = 0.2)) +
  geom_lv(k = 4, outlier.shape = NA, position = position_dodge(width = 0.8)) +
  geom_boxplot(outlier.alpha = 0, coef = 0, fill = "#00000000", aes(color = group), width = 0.8, linewidth = 0.15) +
  geom_hline(yintercept = 0, color = "#fb8072", linewidth = 1, lty = "dashed") +
  geom_text(data = . %>% group_by(group, interval) %>% summarise(median = median(diff, na.rm = T)) %>% ungroup(), 
            aes(x = interval, y = median, group = group,
                label = paste0(round(median, digits = 1), " %")), 
            position = position_dodge(width = 0.75), 
            size = 4, 
            color = "white") +
  scale_y_continuous(expand = c(0, 0), 
                     breaks = breaks_pretty(n = 5), 
                     labels = number_format(suffix = " %")) +
  scale_fill_manual(values = ls_colors) +
  scale_color_manual(values = c("grey80", "grey80")) + 
  labs(fill = NULL, 
       color = NULL, 
       x = NULL, 
       y = "Estimated error in fractional savings", 
       subtitle = str_glue("All {A_building} buildings with measured weather")) +
  coord_cartesian(ylim = c(-10, 10)) +
  theme(panel.grid.major.y = element_line(color = "grey80", linewidth = 0.25),
        legend.position = "bottom",
        axis.text.x = element_blank(),
        plot.margin = margin(t = 2, r = 7, b = 2, l = 2, unit = "mm"))

# TMY version
df_drop <- df_interval_drop_stable %>% 
  bind_rows(df_interval_drop_variable) %>% 
  select(name, contains("tmy")) %>% 
  rename("drop_1" = "interval_tmy_1",
         "drop_2" = "interval_tmy_2", 
         "drop_3" = "interval_tmy_3", 
         "drop_7" = "interval_tmy_7")  

df_keep <- df_interval_keep_stable %>% 
  bind_rows(df_interval_keep_variable) %>% 
  select(name, contains("tmy")) %>% 
  rename("keep_1" = "interval_tmy_1",
         "keep_2" = "interval_tmy_2", 
         "keep_3" = "interval_tmy_3", 
         "keep_7" = "interval_tmy_7")

df_TW_A <- df_drop %>% 
  left_join(df_keep, by = c("name")) %>%
  left_join(rbind(df_fs_stable %>% 
                    filter(scenario == "ref" & method == "true"), 
                  df_fs_variable %>% 
                    filter(scenario == "ref" & method == "true")), by = "name") %>% 
  mutate(drop_1 = savings - drop_1,
         drop_2 = savings - drop_2, 
         drop_3 = savings - drop_3, 
         drop_7 = savings - drop_7, 
         keep_1 = savings - keep_1,
         keep_2 = savings - keep_2, 
         keep_3 = savings - keep_3, 
         keep_7 = savings - keep_7) %>% 
  pivot_longer(cols = contains("drop") | contains("keep"),  
               names_to = c("group", "interval"),
               names_pattern = "(drop|keep)_(\\d+)",
               values_to = "diff")

p_bottom <- df_TW_A %>% 
  mutate(interval = as.factor(interval), 
         interval = recode_factor(interval, 
                                  "1" = "1-day\nsampling",
                                  "2" = "2-day\nsampling", 
                                  "3" = "3-day\nsampling", 
                                  "7" = "7-day\nsampling"), 
         group = as.factor(group), 
         group = recode_factor(group, "drop" = "Dropped", "keep" = "Kept")) %>% 
  ggplot(aes(x = interval, y = diff, fill = group)) +
  geom_jitter(alpha = 0.8, 
              size = 0.5, 
              position = position_jitterdodge(dodge.width = 0.75, jitter.width = 0.2)) +
  geom_lv(k = 4, outlier.shape = NA, position = position_dodge(width = 0.8)) +
  geom_boxplot(outlier.alpha = 0, coef = 0, fill = "#00000000", aes(color = group), width = 0.8, linewidth = 0.15) +
  geom_hline(yintercept = 0, color = "#fb8072", linewidth = 1, lty = "dashed") +
  geom_text(data = . %>% group_by(group, interval) %>% summarise(median = median(diff, na.rm = T)) %>% ungroup(), 
            aes(x = interval, y = median, group = group,
                label = paste0(round(median, digits = 1), " %")), 
            position = position_dodge(width = 0.75), 
            size = 4, 
            color = "white") +
  scale_y_continuous(expand = c(0, 0), 
                     breaks = breaks_pretty(n = 5), 
                     labels = number_format(suffix = " %")) +
  scale_fill_manual(values = ls_colors) +
  scale_color_manual(values = c("grey80", "grey80")) + 
  labs(fill = NULL, 
       color = NULL, 
       x = NULL, 
       y = "Estimated error in fractional savings", 
       subtitle = str_glue("All {A_building} buildings with TOWT model and TMY weather")) +
  coord_cartesian(ylim = c(-10, 10)) +
  theme(panel.grid.major.y = element_line(color = "grey80", linewidth = 0.25),
        legend.position = "bottom",
        plot.margin = margin(t = 2, r = 7, b = 2, l = 2, unit = "mm"))

ggarrange(p_top, p_bottom, 
          ncol = 1, nrow = 2, 
          align = "hv", 
          labels = c("a)", "b)"),
          common.legend = T, 
          legend = "bottom") +
  plot_annotation(title = "Estimated error in savings estimation of randomized M&V by different sampling intervals")
```

```{r 6weekstartT, fig.cap = "Time required to satisfy all stopping criteria starting from March and using a shorter blocking period of 6 weeks"}

knitr::include_graphics(paste0(fig_path, "6week_start_time.png"))
```
